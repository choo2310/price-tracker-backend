<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport"="content="width=device-width, initial-scale=1.0">
    <title>Price Tracker WebSocket Monitor</title>
    <style>
      body {
        font-family: "Courier New", monospace;
        background-color: #1a1a1a;
        color: #00ff00;
        margin: 0;
        padding: 20px;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
      }
      .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .status-card {
        background-color: #2a2a2a;
        border: 1px solid #00ff00;
        border-radius: 5px;
        padding: 15px;
      }
      .status-card h3 {
        margin-top: 0;
        color: #00ffff;
      }
      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }
      .status-connected {
        background-color: #00ff00;
      }
      .status-disconnected {
        background-color: #ff0000;
      }
      .messages-container {
        background-color: #2a2a2a;
        border: 1px solid #00ff00;
        border-radius: 5px;
        padding: 15px;
        height: 400px;
        overflow-y: auto;
      }
      .messages-container h3 {
        margin-top: 0;
        color: #00ffff;
      }
      .message {
        margin-bottom: 5px;
        font-size: 12px;
      }
      .message-trade {
        color: #00ff00;
      }
      .message-ping {
        color: #ffff00;
      }
      .message-status {
        color: #00ffff;
      }
      .message-connection {
        color: #ff00ff;
      }
      .timestamp {
        color: #888;
      }
      .controls {
        margin-bottom: 20px;
        text-align: center;
      }
      .btn {
        background-color: #00ff00;
        color: #000;
        border: none;
        padding: 10px 20px;
        margin: 0 5px;
        border-radius: 3px;
        cursor: pointer;
        font-family: inherit;
      }
      .btn:hover {
        background-color: #00cc00;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ðŸš€ Price Tracker WebSocket Monitor</h1>
        <p>Real-time monitoring of Finnhub WebSocket connection</p>
      </div>

      <div class="controls">
        <button class="btn" onclick="toggleMonitoring()">
          Start Monitoring
        </button>
        <button class="btn" onclick="clearMessages()">Clear Messages</button>
        <button class="btn" onclick="refreshStatus()">Refresh Status</button>
      </div>

      <div class="status-grid">
        <div class="status-card">
          <h3>Connection Status</h3>
          <div id="connectionStatus">
            <span class="status-indicator status-disconnected"></span>
            Checking...
          </div>
        </div>
        <div class="status-card">
          <h3>Subscribed Symbols</h3>
          <div id="subscribedSymbols">Loading...</div>
        </div>
        <div class="status-card">
          <h3>Message Statistics</h3>
          <div id="messageStats">
            <div>Total Messages: <span id="messageCount">0</span></div>
            <div>Last Message: <span id="lastMessage">Never</span></div>
            <div>Reconnect Attempts: <span id="reconnectAttempts">0</span></div>
          </div>
        </div>
        <div class="status-card">
          <h3>System Info</h3>
          <div id="systemInfo">
            <div>Server: <span id="serverStatus">Checking...</span></div>
            <div>Uptime: <span id="uptime">-</span></div>
          </div>
        </div>
      </div>

      <div class="messages-container">
        <h3>ðŸ“¡ Live WebSocket Messages</h3>
        <div id="messages"></div>
      </div>
    </div>

    <script>
      let eventSource = null;
      let isMonitoring = false;
      const API_BASE = "http://localhost:3000"; // Change this to your server URL

      function addMessage(type, content, timestamp) {
        const messagesDiv = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message message-${type}`;

        const time = new Date(timestamp).toLocaleTimeString();
        messageDiv.innerHTML = `<span class="timestamp">[${time}]</span> ${content}`;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Keep only last 100 messages
        while (messagesDiv.children.length > 100) {
          messagesDiv.removeChild(messagesDiv.firstChild);
        }
      }

      function updateConnectionStatus(connected) {
        const statusDiv = document.getElementById("connectionStatus");
        const indicator = statusDiv.querySelector(".status-indicator");

        if (connected) {
          indicator.className = "status-indicator status-connected";
          statusDiv.innerHTML =
            '<span class="status-indicator status-connected"></span>Connected';
        } else {
          indicator.className = "status-indicator status-disconnected";
          statusDiv.innerHTML =
            '<span class="status-indicator status-disconnected"></span>Disconnected';
        }
      }

      function updateSubscribedSymbols(symbols) {
        const symbolsDiv = document.getElementById("subscribedSymbols");
        if (symbols && symbols.length > 0) {
          symbolsDiv.innerHTML = symbols.join(", ");
        } else {
          symbolsDiv.innerHTML = "None";
        }
      }

      function updateMessageStats(stats) {
        document.getElementById("messageCount").textContent =
          stats.messageCount || 0;
        document.getElementById("lastMessage").textContent =
          stats.lastMessageTime
            ? new Date(stats.lastMessageTime).toLocaleString()
            : "Never";
        document.getElementById("reconnectAttempts").textContent =
          stats.reconnectAttempts || 0;
      }

      function toggleMonitoring() {
        const btn = event.target;

        if (!isMonitoring) {
          startMonitoring();
          btn.textContent = "Stop Monitoring";
          isMonitoring = true;
        } else {
          stopMonitoring();
          btn.textContent = "Start Monitoring";
          isMonitoring = false;
        }
      }

      function startMonitoring() {
        if (eventSource) {
          eventSource.close();
        }

        eventSource = new EventSource(
          `${API_BASE}/api/status/websocket/stream`
        );

        eventSource.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data);

            switch (data.type) {
              case "connection":
                addMessage("connection", data.message, data.timestamp);
                break;
              case "message":
                const msgData = data.data;
                addMessage(
                  "trade",
                  `${msgData.type} message (${msgData.dataCount} items)`,
                  data.timestamp
                );
                break;
              case "status":
                updateConnectionStatus(data.connected);
                updateSubscribedSymbols(data.subscribedSymbols);
                addMessage(
                  "status",
                  `Status update - Connected: ${data.connected}, Symbols: ${data.subscribedSymbols.length}`,
                  data.timestamp
                );
                break;
            }
          } catch (error) {
            console.error("Error parsing SSE data:", error);
          }
        };

        eventSource.onerror = function (event) {
          addMessage(
            "connection",
            "SSE connection error",
            new Date().toISOString()
          );
          console.error("SSE Error:", event);
        };

        addMessage(
          "connection",
          "Started real-time monitoring",
          new Date().toISOString()
        );
      }

      function stopMonitoring() {
        if (eventSource) {
          eventSource.close();
          eventSource = null;
        }
        addMessage(
          "connection",
          "Stopped real-time monitoring",
          new Date().toISOString()
        );
      }

      function clearMessages() {
        document.getElementById("messages").innerHTML = "";
      }

      async function refreshStatus() {
        try {
          // Get WebSocket status
          const wsResponse = await fetch(`${API_BASE}/api/status/websocket`);
          const wsData = await wsResponse.json();

          if (wsData.success) {
            updateConnectionStatus(wsData.data.connected);
            updateSubscribedSymbols(wsData.data.subscribedSymbols);
            updateMessageStats(wsData.data);
          }

          // Get system status
          const sysResponse = await fetch(`${API_BASE}/api/status`);
          const sysData = await sysResponse.json();

          if (sysData.success) {
            document.getElementById("serverStatus").textContent = "Online";
            document.getElementById("uptime").textContent = formatUptime(
              sysData.data.uptime
            );
          }

          addMessage("status", "Status refreshed", new Date().toISOString());
        } catch (error) {
          addMessage(
            "connection",
            `Error refreshing status: ${error.message}`,
            new Date().toISOString()
          );
          document.getElementById("serverStatus").textContent = "Offline";
        }
      }

      function formatUptime(seconds) {
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);

        if (days > 0) return `${days}d ${hours}h ${minutes}m`;
        if (hours > 0) return `${hours}h ${minutes}m`;
        return `${minutes}m`;
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        refreshStatus();
        addMessage(
          "connection",
          "Monitor page loaded",
          new Date().toISOString()
        );
      });

      // Clean up on page unload
      window.addEventListener("beforeunload", function () {
        if (eventSource) {
          eventSource.close();
        }
      });
    </script>
  </body>
</html>
